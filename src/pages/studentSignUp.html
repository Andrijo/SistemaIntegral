<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Alumno | SGA</title>
    <link rel="shortcut icon" href="/public/favicon.webp" type="image/x-icon" />
    <link rel="stylesheet" href="/src/styles/pages/signup-student.css" />
  </head>
  <body>
    <a href="../../index.html" class="back-btn">‚Üê Volver al inicio</a>

    <div class="container">
      <div class="header">
        <div class="user-type-badge">üë®‚Äçüéì Alumno</div>
        <h1>Crear Cuenta</h1>
        <p>Completa los siguientes datos para registrarte</p>
      </div>

      <div id="successMessage" class="success-message">
        ¬°Cuenta creada exitosamente! Tu matr√≠cula ha sido generada.
      </div>

      <div id="errorMessage" class="error-message">
        Error al crear la cuenta. Por favor, verifica los datos.
      </div>

      <form id="registroForm">
        <div class="form-group">
          <label for="nombre">Nombre completo *</label>
          <input type="text" id="nombre" name="nombre" required minlength="3" />
        </div>

        <div class="form-group">
          <label for="email">Correo electr√≥nico *</label>
          <input type="email" id="email" name="email" required />
        </div>

        <div class="form-group">
          <label for="password">Contrase√±a *</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            minlength="6" />
        </div>

        <div class="form-group">
          <label for="password">Confirma tu contrase√±a *</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            minlength="6" />
        </div>
        <button type="submit" class="submit-btn">Crear Cuenta</button>
      </form>

      <div class="login-link">
        <p>¬øYa tienes cuenta? <a href="/index.html">Iniciar sesi√≥n</a></p>
        <p><a href="registroDeTutor.html">¬øEres tutor? Reg√≠strate aqu√≠</a></p>
      </div>
    </div>

    <script>
      // Variables globales
      let matriculaCounter = 1
      const currentDate = new Date()

      // Formatear fecha
      function formatDate(date) {
        return date.toLocaleDateString("es-ES", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        })
      }

      // Generar matr√≠cula de alumno
      function generateMatriculaAlumno() {
        const year = currentDate.getFullYear().toString().slice(-2)
        const numero = matriculaCounter.toString().padStart(4, "0")
        return `ALU-${year}${numero}`
      }

      // Actualizar matr√≠cula en tiempo real
      function updateMatricula() {
        const matricula = generateMatriculaAlumno()
        document.getElementById("matriculaPreview").textContent = matricula
      }

      // Inicializar p√°gina
      function init() {
        // Mostrar fecha actual
        document.getElementById("fechaRegistro").textContent =
          formatDate(currentDate)

        // Generar matr√≠cula inicial
        updateMatricula()

        // Actualizar contador desde localStorage si existe
        const savedCounter = localStorage.getItem("alumnoCounter")
        if (savedCounter) {
          matriculaCounter = parseInt(savedCounter) + 1
          updateMatricula()
        }
      }

      // Validar formulario
      function validateForm(formData) {
        const errors = []

        if (formData.nombre.length < 3) {
          errors.push("El nombre debe tener al menos 3 caracteres")
        }

        if (!formData.email.includes("@")) {
          errors.push("Email inv√°lido")
        }

        if (!/^[0-9]{10}$/.test(formData.telefono)) {
          errors.push("El tel√©fono debe tener 10 d√≠gitos")
        }

        if (formData.username.length < 4) {
          errors.push("El nombre de usuario debe tener al menos 4 caracteres")
        }

        if (formData.password.length < 6) {
          errors.push("La contrase√±a debe tener al menos 6 caracteres")
        }

        return errors
      }

      // Mostrar mensajes
      function showMessage(type, message) {
        const successMsg = document.getElementById("successMessage")
        const errorMsg = document.getElementById("errorMessage")

        if (type === "success") {
          successMsg.textContent = message
          successMsg.style.display = "block"
          errorMsg.style.display = "none"
        } else {
          errorMsg.textContent = message
          errorMsg.style.display = "block"
          successMsg.style.display = "none"
        }

        // Scroll hacia arriba para ver el mensaje
        document.querySelector(".container").scrollTop = 0
      }

      // Guardar usuario (simulado - localStorage)
      function saveUser(userData) {
        try {
          // Obtener usuarios existentes
          const existingUsers = JSON.parse(
            localStorage.getItem("usuarios_alumnos") || "[]"
          )

          // Verificar si el email o username ya existen
          const emailExists = existingUsers.some(
            (user) => user.email === userData.email
          )
          const usernameExists = existingUsers.some(
            (user) => user.username === userData.username
          )

          if (emailExists) {
            throw new Error("El email ya est√° registrado")
          }

          if (usernameExists) {
            throw new Error("El nombre de usuario ya est√° en uso")
          }

          // Agregar nuevo usuario
          existingUsers.push(userData)

          // Guardar en localStorage
          localStorage.setItem(
            "usuarios_alumnos",
            JSON.stringify(existingUsers)
          )
          localStorage.setItem("alumnoCounter", matriculaCounter)

          return true
        } catch (error) {
          console.error("Error al guardar usuario:", error)
          throw error
        }
      }

      // Manejar env√≠o del formulario
      document
        .getElementById("registroForm")
        .addEventListener("submit", function (e) {
          e.preventDefault()

          // Obtener datos del formulario
          const formData = {
            nombre: document.getElementById("nombre").value.trim(),
            email: document.getElementById("email").value.trim().toLowerCase(),
            telefono: document.getElementById("telefono").value.trim(),
            username: document.getElementById("username").value.trim(),
            password: document.getElementById("password").value,
            matricula: document.getElementById("matriculaPreview").textContent,
            fechaRegistro: currentDate.toISOString(),
            tipoUsuario: "alumno",
          }

          // Validar datos
          const errors = validateForm(formData)
          if (errors.length > 0) {
            showMessage("error", errors.join(". "))
            return
          }

          // Deshabilitar bot√≥n
          const submitBtn = document.querySelector(".submit-btn")
          submitBtn.disabled = true
          submitBtn.textContent = "Creando cuenta..."

          // Simular delay de red
          setTimeout(() => {
            try {
              saveUser(formData)
              showMessage(
                "success",
                `¬°Cuenta creada exitosamente! Tu matr√≠cula es: ${formData.matricula}`
              )

              // Limpiar formulario
              document.getElementById("registroForm").reset()

              // Generar nueva matr√≠cula para el siguiente usuario
              matriculaCounter++
              updateMatricula()

              // Opcional: redirigir despu√©s de 3 segundos
              setTimeout(() => {
                window.location.href = "index.html"
              }, 3000)
            } catch (error) {
              showMessage("error", error.message)
            } finally {
              submitBtn.disabled = false
              submitBtn.textContent = "Crear Cuenta"
            }
          }, 1000)
        })

      // Actualizar matr√≠cula cuando cambie el nombre
      document.getElementById("nombre").addEventListener("input", function () {
        if (this.value.trim()) {
          updateMatricula()
        }
      })

      //Volver al index en la ruta correcta
      document
        .getElementById("back-btn")
        .addEventListener("click", function () {
          e.preventDefault()
          window.location.href = "../../index.html"
        })

      // Inicializar cuando cargue la p√°gina
      document.addEventListener("DOMContentLoaded", init)
    </script>
  </body>
</html>
